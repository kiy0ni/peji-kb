name: Node.js CI

# Triggers the workflow on push and pull request events to main and develop branches.
on:
  push:
    branches: ['main', 'develop']
  pull_request:
    branches: ['main', 'develop']

jobs:
  quality-check:
    name: Build, Lint, Format & Test
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    # Environment variables required for application boot and test configuration.
    env:
      NODE_ENV: test
      PORT: 3000
      SESSION_SECRET: 'ci-secret-key-placeholder'
      ADMIN_CODE: 'admin-ci-test'
      AI_PROVIDER: 'ollama'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for Gitleaks to scan the entire history

      # VERIFICATION 1: Secret Scanning (Gitleaks)
      # Fails the CI pipeline if an API key or password is detected in the code
      - name: Detect Secrets
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        # 'npm ci' is recommended over 'npm install' in CI environments
        run: npm ci

      # VERIFICATION 2: Formatting (Prettier)
      # Checks if the code adheres to the defined style (indentation, commas, etc.)
      - name: Check Formatting
        run: npm run format:check

      # VERIFICATION 3: Linting (Code Quality)
      # Checks for logical errors and code quality issues (unused variables, etc.)
      - name: Run Linter
        run: npm run lint

      # VERIFICATION 4: Tests & Coverage
      # Runs unit tests and displays the code coverage percentage
      - name: Run Tests with Coverage
        run: npm run test:coverage

      # (Optional) Security check for dependencies
      - name: Audit Dependencies
        run: npm audit --audit-level=high
        continue-on-error: true # Set to true to avoid blocking PRs on minor issues
